name: Build and Release iOS

on:
  workflow_dispatch: {}
  push:
    tags:
      - ios-v*

jobs:
  ios:
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    env:
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      APP_BUNDLE_ID: gr.formypet.app
      BUILD_NUMBER: ${{ github.run_number }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Xcode 16
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.*'

      - name: Show selected Xcode / SDK
        run: |
          xcodebuild -version
          xcrun --sdk iphoneos --show-sdk-version

      # 3) Node / build web assets
      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure npm auth (optional)
        run: |
          if [ -n "${NPM_TOKEN:-}" ]; then
            npm config set //registry.npmjs.org/:_authToken=${NPM_TOKEN}
          fi
          npm config set audit false
          npm config set fund false

      - name: Install JS dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Build web assets (create ./dist)
        run: npm run build

      # 4) Ruby & Bundler (Ï€ÏÎ¹Î½ Ï„Î¿ cap sync Î³Î¹Î± Î½Î± Î´Î¿Ï…Î»Î­ÏˆÎµÎ¹ bundler/pods ÏƒÏ‰ÏƒÏ„Î¬)
      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Install gems for iOS (cocoapods/fastlane)
        working-directory: ios/App
        run: |
          bundle config set path vendor/bundle
          bundle install --jobs 4 --retry 3

      # 5) Capacitor sync Î§Î©Î¡Î™Î£ pods (pods Î¸Î± Ï„ÏÎ­Î¾Î¿Ï…Î½ Î¼Î­ÏƒÏ‰ bundler)
      - name: Sync Capacitor iOS (skip pods)
        env:
          CAPACITOR_SKIP_POD_INSTALL: '1'
        run: npx cap sync ios

      # 6) Firebase plist Î±Ï€ÏŒ secrets
      - name: Write GoogleService-Info.plist (from secret)
        env:
          FIREBASE_IOS_PLIST_BASE64: ${{ secrets.FIREBASE_IOS_PLIST_BASE64 }}
        run: |
          set -e
          mkdir -p ios/App/App
          echo "$FIREBASE_IOS_PLIST_BASE64" | base64 --decode > ios/App/App/GoogleService-Info.plist
          /usr/bin/plutil -lint ios/App/App/GoogleService-Info.plist
          /usr/libexec/PlistBuddy -c "Print :BUNDLE_ID" ios/App/App/GoogleService-Info.plist

      - name: Add GoogleService-Info.plist to target Resources
        working-directory: ios/App
        run: |
          gem install xcodeproj -N
          ruby -e "require 'xcodeproj';
            p='App.xcodeproj'; proj=Xcodeproj::Project.open(p);
            t=proj.targets.find{|t| t.name=='App'} or abort('No target App');
            path='App/GoogleService-Info.plist';
            ref=proj.main_group.find_file_by_path(path) || proj.main_group.new_file(path);
            unless t.resources_build_phase.files_references.include?(ref)
              t.add_resources([ref]); puts 'Added GoogleService-Info.plist to Resources';
            else
              puts 'GoogleService-Info.plist already in Resources';
            end
            proj.save"

      # 7) Entitlements (Debug=development, Release=production)
      - name: Create entitlements files
        run: |
          set -e
          mkdir -p ios/App/App
          cat > ios/App/App/AppDebug.entitlements <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>aps-environment</key><string>development</string>
          </dict></plist>
          EOF
          cat > ios/App/App/AppRelease.entitlements <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>aps-environment</key><string>production</string>
          </dict></plist>
          EOF

      - name: Inject entitlements & capabilities
        working-directory: ios/App
        run: |
          ruby -e "require 'xcodeproj';
          p='App.xcodeproj'; proj=Xcodeproj::Project.open(p);
          t=proj.targets.find{|t| t.name=='App'} or abort('No target App');
          t.build_configurations.each do |cfg|
            cfg.build_settings['CODE_SIGN_ENTITLEMENTS'] =
              (cfg.name == 'Debug') ? 'App/AppDebug.entitlements' : 'App/AppRelease.entitlements'
          end
          attrs = proj.root_object.attributes['TargetAttributes'] ||= {}
          attrs[t.uuid] ||= {}
          caps = attrs[t.uuid]['SystemCapabilities'] ||= {}
          caps['com.apple.Push'] = {'enabled'=>1}
          caps['com.apple.BackgroundModes'] = {'enabled'=>1}
          proj.save"

      # 8) CocoaPods Î¼Îµ bundler
      - name: CocoaPods install
        working-directory: ios/App
        run: |
          bundle exec pod repo update
          bundle exec pod install --repo-update

      # 9) (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) Î”ÎµÎ¯Î¾Îµ schemes / Î²Î±ÏƒÎ¹ÎºÎ¬ build settings
      - name: Show schemes & build settings
        run: |
          xcodebuild -list -workspace ios/App/App.xcworkspace
          xcodebuild -showBuildSettings -workspace ios/App/App.xcworkspace -scheme App -configuration Release | egrep 'INFOPLIST_FILE|PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|CODE_SIGN_STYLE|PROVISIONING_PROFILE_SPECIFIER' || true

      # 10) Fix Matchfile: Î²Î¬Î»Îµ app_identifier (Î±Ï€Î¿Ï†Ï…Î³Î® "No value found")
      - name: Ensure Matchfile has app_identifier
        working-directory: ios/App/fastlane
        env:
          APP_BUNDLE_ID: ${{ env.APP_BUNDLE_ID }}
        run: |
          set -e
          test -n "$APP_BUNDLE_ID" || { echo "âŒ APP_BUNDLE_ID env missing"; exit 1; }
          if grep -qE '^\s*app_identifier' Matchfile; then
            sed -i.bak -E "s#^\s*app_identifier.*#app_identifier([\"$APP_BUNDLE_ID\"])#g" Matchfile
          else
            printf '\napp_identifier(["%s"])\n' "$APP_BUNDLE_ID" >> Matchfile
          fi
          echo "== Matchfile ==" && cat Matchfile

      # 11) SSH Î³Î¹Î± match repo (certs/profiles)
      - name: Start ssh-agent (for match repo)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}

      - name: Add github.com to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 12) Fastlane release (TestFlight)
      - name: Fastlane release (TestFlight)
        working-directory: ios/App
        env:
          APP_BUNDLE_ID: ${{ env.APP_BUNDLE_ID }}
          BUILD_NUMBER: ${{ env.BUILD_NUMBER }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BRANCH: main
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: bundle exec fastlane release


      # 14) Post-build Î­Î»ÎµÎ³Ï‡Î¿Î¹ IPA (GoogleService-Info & aps-environment)
      - name: Post-build IPA checks
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          # 1) Î’ÏÎµÏ‚ IPA Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î±
          candidates=(ios/App/build/*.ipa)
          if [[ ${#candidates[@]} -eq 0 ]]; then
          # fallback: Î´Î¿ÎºÎ¯Î¼Î±ÏƒÎµ ÎºÎ±Î¹ Î¬Î»Î»Î± Ï€Î¹Î¸Î±Î½Î¬ locations Î±Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹
            candidates=(ios/App/*.ipa *.ipa)
          fi
          if [[ ${#candidates[@]} -eq 0 ]]; then
            echo "âŒ No IPA found (tried ios/App/build, ios/App, repo root)"
            ls -al ios/App/build || true
            exit 1
          fi
          IPA="${candidates[0]}"
          echo "ðŸ“¦ Inspecting: $IPA"

          # 2) Extract IPA
          TMP="$(mktemp -d)"
          unzip -q "$IPA" -d "$TMP"

          # 3) Î’ÏÎµÏ‚ .app (Ï‡Ï‰ÏÎ¯Ï‚ -maxdepth ÏƒÎµ BSD find)
          APP_PATH="$(find "$TMP/Payload" -type d -name '*.app' -print -quit)"
          if [[ -z "$APP_PATH" ]]; then
            echo "âŒ .app not found under Payload"
            find "$TMP" -maxdepth 3 -type d -name '*.app' 2>/dev/null || true
            exit 1
          fi
          echo "ðŸ§© App bundle: $APP_PATH"

          # 4) GoogleService-Info.plist
          echo "== Check GoogleService-Info.plist =="
          if [[ ! -f "$APP_PATH/GoogleService-Info.plist" ]]; then
            echo "âŒ GoogleService-Info.plist is missing from .app"
            find "$APP_PATH" -name 'GoogleService-Info.plist' | sed 's/^/ - /' || true
            exit 1
          fi
          /usr/bin/plutil -lint "$APP_PATH/GoogleService-Info.plist" \
            || { echo "âŒ Invalid GoogleService-Info.plist"; exit 1; }
          # /usr/libexec/PlistBuddy -c 'Print :BUNDLE_ID' "$APP_PATH/GoogleService-Info.plist" || true

          # 5) Entitlements
          echo "== Check aps-environment (entitlements & provisioning) =="
          /usr/bin/codesign -d --entitlements :- "$APP_PATH" > entitlements.plist 2>/dev/null \
            || { echo "âŒ Could not extract entitlements"; exit 1; }
          /usr/libexec/PlistBuddy -c 'Print :aps-environment' entitlements.plist \
            || { echo "âŒ aps-environment missing in entitlements"; exit 1; }

          # 6) Provisioning profile
          if [[ -f "$APP_PATH/embedded.mobileprovision" ]]; then
            /usr/bin/security cms -D -i "$APP_PATH/embedded.mobileprovision" > profile.plist
            /usr/libexec/PlistBuddy -c 'Print :Entitlements:aps-environment' profile.plist || true
            /usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' profile.plist || true
          else
            echo "âŒ embedded.mobileprovision missing"
            exit 1
          fi

          echo "âœ… IPA checks passed"
    
      # 13) Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· ÏŒÏ„Î¹ Ï„Î¿ IPA Î­Ï‡ÎµÎ¹ GoogleService-Info.plist ÎºÎ±Î¹ aps-environment
      - name: Verify Firebase plist & aps in IPA
        run: |
          set -e
          IPA=$(ls -t ios/App/build/*.ipa 2>/dev/null | head -n1)
          if [ -z "$IPA" ]; then echo "âŒ No IPA found in ios/App/build"; exit 1; fi
          echo "Inspecting $IPA"
          TMP=$(mktemp -d); unzip -q "$IPA" -d "$TMP"
          APP_PATH=$(find "$TMP/Payload" -name "*.app" -maxdepth 1 | head -n1)

          echo "== Check GoogleService-Info.plist in app bundle =="
          if [ ! -f "$APP_PATH/GoogleService-Info.plist" ]; then
            echo "âŒ GoogleService-Info.plist is missing from .app"; exit 1
          fi
          /usr/bin/plutil -lint "$APP_PATH/GoogleService-Info.plist"
          /usr/libexec/PlistBuddy -c "Print :BUNDLE_ID" "$APP_PATH/GoogleService-Info.plist" || true

          echo "== Check aps-environment (entitlements & provisioning) =="
          /usr/bin/codesign -d --entitlements :- "$APP_PATH" > entitlements.plist
          /usr/libexec/PlistBuddy -c "Print :aps-environment" entitlements.plist
          /usr/bin/security cms -D -i "$APP_PATH/embedded.mobileprovision" > profile.plist
          /usr/libexec/PlistBuddy -c "Print :Entitlements:aps-environment" profile.plist

      # 14) Artifacts / logs
      - name: Upload IPA & logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            ios/App/build/*.ipa
            ~/Library/Logs/gym/*
            ~/Library/Developer/Xcode/DerivedData/**/Logs/**
