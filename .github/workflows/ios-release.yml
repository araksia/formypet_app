name: Build and Release iOS

on:
  workflow_dispatch:
  push:
    tags:
      - 'ios-v*'

jobs:
  ios:
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    env:
      BUNDLE_PATH: vendor/bundle
      LC_ALL: en_US.UTF-8
      LANG: en_US.UTF-8
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}          # << Î•Î”Î© ÏƒÏ„Î¿ job
      APP_BUNDLE_ID: gr.formypet.app   # ğŸ‘ˆ ÎµÎ´Ï

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Î•Ï€Î¹Î»Î¿Î³Î® Xcode
      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.*'   # Î® 16.1 / 16.2 Îº.Î»Ï€.
      
      - name: Show selected Xcode / SDK
        run: |
          xcodebuild -version
          xcrun --sdk iphoneos --show-sdk-version

      # 3) Ruby & Bundler
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: Install gems
        working-directory: ios/App
        run: |
          bundle install --jobs 4 --retry 3
          
      # Node.js Î³Î¹Î± Capacitor/JS
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install JS dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Build web assets (create ./dist)
        run: npm run build
          
      # Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Capacitor -> iOS (Ï‡Ï‰ÏÎ¯Ï‚ pod install ÎµÎ´Ï)
      - name: Sync Capacitor iOS (skip pods)
        env:
          CAPACITOR_SKIP_POD_INSTALL: '1'
        run: npx cap sync ios

      # 4) CocoaPods
      - name: Install CocoaPods
        working-directory: ios/App
        run: |
          if bundle exec pod --version >/dev/null 2>&1; then
            echo "Using CocoaPods from Gemfile"
          else
            gem install cocoapods -N
          fi
          pod repo update
          bundle exec pod install --repo-update || pod install --repo-update

      # 5) Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ shared scheme, Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î¿Ï…Î¼Îµ Ï€Î¹Î¸Î±Î½ÏŒ user scheme ÏƒÎµ shared
      - name: Ensure shared scheme exists
        working-directory: ios/App
        run: |
          set -euo pipefail
          PROJ="App.xcodeproj"
          SHARE="$PROJ/xcshareddata/xcschemes"
          USERDIR=$(ls -1d "$PROJ"/xcuserdata/* 2>/dev/null | head -n1 || true)
          if [ -n "$USERDIR" ] && [ -d "$USERDIR/xcschemes" ]; then
            mkdir -p "$SHARE"
            cp "$USERDIR/xcschemes/"*.xcscheme "$SHARE"/ || true
            echo "Copied user schemes to shared."
          else
            echo "No user schemes to copy (if archive fails, share the 'App' scheme locally and commit)."
          fi

      # 6) Î“ÏÎ®Î³Î¿ÏÎ¿Ï‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ (Î´ÎµÎ½ Î¼Ï€Î»Î¿ÎºÎ¬ÏÎµÎ¹)
      - name: Sanity check workspace & signing
        run: |
          ls -la ios/App
          /usr/bin/xcodebuild -list -workspace ios/App/App.xcworkspace || true
          /usr/bin/xcodebuild -showBuildSettings \
            -workspace ios/App/App.xcworkspace \
            -scheme App | egrep 'PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|CODE_SIGN_STYLE|PROVISIONING_PROFILE_SPECIFIER|IPHONEOS_DEPLOYMENT_TARGET' || true

      # 7) SSH Î³Î¹Î± Ï„Î¿ match repo (deploy key)
      - name: Start ssh-agent (for match repo)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}

      - name: Add github.com to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Configure Git for match
        run: |
          git config --global user.email "ci@github.actions"
          git config --global user.name "GitHub Actions"

      # (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ) ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÏ„Î¿ certs repo
      - name: Check access to match repo
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: git ls-remote "$MATCH_GIT_URL" -h
        
      - name: Upload Xcode logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-logs
          path: ~/Library/Logs/gym/*

      # 8) Build & Release Î¼Î­ÏƒÏ‰ fastlane (lane: ios release)
      - name: Build & Release with fastlane
        working-directory: ios/App
        env:
          # match (SSH + branch main)
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}       # Ï€.Ï‡. git@github.com:araksia/formypet-ios-certificates.git
          MATCH_GIT_BRANCH: main
          MATCH_KEYCHAIN_PASSWORD: ${{ secrets.MATCH_KEYCHAIN_PASSWORD }}   # <â€”
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }} 
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}   # <â€” ÎÎ•ÎŸ


          # App Store Connect API key (Ï„Î¿ .p8 Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ ÏƒÎµ Î±Ï…Ï„ÏŒ Ï„Î¿ secret)
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

          # Team & bundle id Ï€Î¿Ï… Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ Î¿ Fastfile
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_ID: ${{ secrets.APPLE_APP_ID }}
          BUILD_NUMBER: ${{ github.run_number }}   # <-- Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·
        run: bundle exec fastlane release
