# ΣΩΣΤΗ ΣΕΙΡΑ
default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :release do
    
    # 1. Συνδέεται στο App Store Connect με το API Key
    app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
        is_key_content_base64: false
    )

    # 2. Τώρα το match τρέχει, αφού έχει γίνει η σύνδεση
	match(
	  type: "appstore",
	  readonly: false,
	  git_url: ENV["MATCH_GIT_URL"],
	  git_basic_authorization: Base64.strict_encode64("#{ENV["MATCH_GIT_USERNAME"]}:#{ENV["MATCH_GIT_TOKEN"]}"),
	  team_id: ENV["APPLE_TEAM_ID"],
	  keychain_password: ENV["KEYCHAIN_PASSWORD"],
	  keychain_name: "build.keychain" # <-- ΝΕΑ ΠΡΟΣΘΗΚΗ
	)

	update_project_team(
	  teamid: ENV["APPLE_TEAM_ID"]
	)

    # 3. Δημιουργεί το .ipa αρχείο
    gym(scheme: "App", export_method: "app-store")

    # 4. Ανεβάζει το build στο TestFlight
    upload_to_testflight(
        app_identifier: ENV['APPLE_APP_ID'],
        skip_waiting_for_build_processing: true
    )
  end
end
