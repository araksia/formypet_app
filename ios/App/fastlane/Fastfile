default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :release do
    # App Store Connect auth (API Key)
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: false
    )

    # App Store certs/profiles από το match (SSH repo, branch master)
    match(
      type: "appstore",
      readonly: false,                        # άφησέ το false μέχρι να “γεμίσει” το repo. Μετά ξανά true.
      storage_mode: "git",
      git_url: ENV["MATCH_GIT_URL"],          # π.χ. git@github.com:araksia/formypet-ios-certificates.git
      git_branch: "master",
      team_id: ENV["APPLE_TEAM_ID"],
      keychain_name: "build.keychain",
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
    )

    # Manual signing στο project & σωστή ομάδα
    automatic_code_signing(
      path: "App.xcodeproj",
      use_automatic_signing: false,
      team_id: ENV["APPLE_TEAM_ID"]
    )
    update_project_team(teamid: ENV["APPLE_TEAM_ID"])

    # === ΠΑΡΕ ΤΟ ΠΡΑΓΜΑΤΙΚΟ ΟΝΟΜΑ/UUID ΤΟΥ PROFILE ΑΠΟ ΤΑ ENV ΤΟΥ match ===
    app_id        = ENV['APPLE_APP_ID']                   # π.χ. com.company.app
    sanitized_bid = app_id.gsub('.', '_')
    # π.χ. sigh_com_company_app_appstore_profile-name => "match AppStore com.company.app 1755..."
    profile_name  = ENV["sigh_#{sanitized_bid}_appstore_profile-name"] || "match AppStore #{app_id}"
    # π.χ. sigh_com_company_app_appstore => "8C086981-...."
    profile_uuid  = ENV["sigh_#{sanitized_bid}_appstore"] || ENV["sigh_#{sanitized_bid}_appstore_uuid"]

    UI.message("Using provisioning profile: #{profile_name} (#{profile_uuid})")

    # Archive με Release + manual signing + ρητό provisioning
    gym(
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      xcargs: [
        "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
        "CODE_SIGN_STYLE=Manual",
        # δώσε ΚΑΙ specifier (name) ΚΑΙ uuid για πλήρη ταύτιση
        ("PROVISIONING_PROFILE_SPECIFIER='#{profile_name}'" if profile_name),
        ("PROVISIONING_PROFILE='#{profile_uuid}'" if profile_uuid)
      ].compact.join(' '),
      export_options: {
        provisioningProfiles: { app_id => profile_name },
        signingStyle: "manual",
        compileBitcode: false
      }
    )

    # Upload στο TestFlight
    upload_to_testflight(
      app_identifier: app_id,
      skip_waiting_for_build_processing: true
    )
  end
end
