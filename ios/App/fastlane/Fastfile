# fastlane/Fastfile

default_platform(:ios)

platform :ios do
  desc "Build & upload to TestFlight"
  lane :release do
    # 1) App Store Connect API key (από secrets)
    api_key = app_store_connect_api_key(
      key_id:     ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id:  ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT']
    )

    # 2) match (App Store) με API key
    match(
      type: "appstore",
      readonly: true,
      api_key: api_key
    )

    # 3) Automatic signing ΠΡΙΝ το gym
    update_project_team(
	  path: "App.xcodeproj",
	  teamid: ENV['APPLE_TEAM_ID'],
	  targets: ["App"]
	)

	automatic_code_signing(
	  path: "App.xcodeproj",
	  use_automatic_signing: false,   # <-- manual
	  team_id: ENV['APPLE_TEAM_ID'],
	  targets: ["App"]
	)
	
	# 4) Build/Archive με ρητή δήλωση του profile από το match
	profile_name = "match AppStore #{ENV['APPLE_APP_ID']}"  # fastlane standard name

	# ΠΑΡΕ τον χάρτη που έδωσε το match (έχει το ακριβές profile name με timestamp)
	profiles_map = Actions.lane_context[SharedValues::MATCH_PROVISIONING_PROFILE_MAPPING]
	UI.message("Using provisioning profiles: #{profiles_map}")

    # 4) Build/Archive
	gym(
	  scheme: "App",
	  workspace: "App.xcworkspace",
	  configuration: "Release",
	  clean: true,
	  export_method: "app-store",
	  # Manual signing – ΔΕΝ ζητάμε να δημιουργηθούν προφίλ αυτόματα
	  xcargs: "CODE_SIGN_STYLE=Manual DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
	  export_options: {
		signingStyle: "manual",
		provisioningProfiles: profiles_map
	  }
	)

    # 5) Upload στο TestFlight
    upload_to_testflight(
      app_identifier: ENV['APPLE_APP_ID'], # = bundle identifier (π.χ. com.company.app)
      skip_waiting_for_build_processing: true
    )
  end
end
