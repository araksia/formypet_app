default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :release do
    # App Store Connect auth (API Key)
    app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: ENV['APP_STORE_CONNECT_API_KEY_CONTENT'],
      is_key_content_base64: false
    )

    # Κατέβασε certificates/profiles από το match (SSH repo, branch master)
    # Παίρνουμε και development και appstore για πλήρη κάλυψη
    %w[development appstore].each do |t|
      match(
        type: t,
        readonly: true,
        storage_mode: "git",
        git_url: ENV["MATCH_GIT_URL"],     # π.χ. git@github.com:araksia/formypet-ios-certificates.git
        git_branch: "master",
        team_id: ENV["APPLE_TEAM_ID"],
        keychain_name: "build.keychain",
        keychain_password: ENV["KEYCHAIN_PASSWORD"]
      )
    end

    # Κλειδώνουμε manual signing στο project & σωστή ομάδα
    automatic_code_signing(
      path: "App.xcodeproj",
      use_automatic_signing: false,
      team_id: ENV["APPLE_TEAM_ID"]
    )
    update_project_team(teamid: ENV["APPLE_TEAM_ID"])

    # Ορισμοί για το provisioning που θα χρησιμοποιηθεί στο Release
    app_id       = ENV['APPLE_APP_ID']                 # bundle id, π.χ. com.company.app
    profile_name = "match AppStore #{app_id}"          # default όνομα που φτιάχνει το match

    # Archive με Release + manual signing + ρητό provisioning
    gym(
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      xcargs: [
        "DEVELOPMENT_TEAM=#{ENV['APPLE_TEAM_ID']}",
        "CODE_SIGN_STYLE=Manual",
        "CODE_SIGN_IDENTITY=Apple Distribution",
        "PROVISIONING_PROFILE_SPECIFIER='#{profile_name}'"
      ].join(' '),
      export_options: {
        provisioningProfiles: { app_id => profile_name },
        signingStyle: "manual",
        compileBitcode: false
      }
    )

    # Upload στο TestFlight
    upload_to_testflight(
      app_identifier: app_id,
      skip_waiting_for_build_processing: true
    )
  end
end
