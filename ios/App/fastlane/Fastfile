lane :release do
  api_key = app_store_connect_api_key(
    key_id:      ENV.fetch('APP_STORE_CONNECT_API_KEY_ID'),
    issuer_id:   ENV.fetch('APP_STORE_CONNECT_API_ISSUER_ID'),
    key_content: ENV.fetch('APP_STORE_CONNECT_API_KEY_CONTENT')
  )

  increment_build_number(build_number: ENV['BUILD_NUMBER'])

  create_keychain(
    name: "build.keychain",
    password: ENV['KEYCHAIN_PASSWORD'],
    default_keychain: true,
    unlock: true,
    timeout: 3600,
    lock_when_sleeps: true
  )

  match(
    type: "appstore",
    readonly: true,
    git_url: ENV['MATCH_GIT_URL'],
    git_branch: ENV['MATCH_GIT_BRANCH'],
    app_identifier: ENV['APP_BUNDLE_ID'],
    team_id: ENV['APPLE_TEAM_ID'],
    keychain_name: "build.keychain",
    keychain_password: ENV['KEYCHAIN_PASSWORD']
  )

  gym(
    scheme: "App",
    workspace: "App.xcworkspace",
    configuration: "Release",
    export_method: "app-store",
    # ğŸ”½ Î•Î”Î© Î¿ÏÎ¯Î¶Î¿Ï…Î¼Îµ Ï€Î¿Ï ÎºÎ±Î¹ Ï€ÏÏ‚ Î¸Î± Î²Î³ÎµÎ¹ Ï„Î¿ IPA
    output_directory: "build",
    output_name: "App_#{ENV['BUILD_NUMBER']}",
    skip_package_ipa: false
  )

  # Î Î¬ÏÎµ Ï„Î¿ path Ï„Î¿Ï… IPA Î±Ï€ÏŒ Ï„Î¿ gym ÎºÎ±Î¹ ÎºÏÎ¬Ï„Î± Ï„Î¿ ÏƒÎ¯Î³Î¿Ï…ÏÎ± ÏƒÏ„Î¿ ios/App/build
  ipa_path = Actions.lane_context[SharedValues::IPA_OUTPUT_PATH]
  sh "mkdir -p build && cp \"#{ipa_path}\" build/"

  upload_to_testflight(
    api_key: api_key,
    app_identifier: ENV['APP_BUNDLE_ID'],
    skip_waiting_for_build_processing: true
  )

  # âŒ ÎœÎ—Î Î²Î¬Î»ÎµÎ¹Ï‚ clean_build_artifacts ÎµÎ´Ï, Î±Î»Î»Î¹ÏÏ‚ Î¸Î± ÏƒÎ²Î®ÏƒÎµÎ¹ Ï„Î¿ IPA
end
